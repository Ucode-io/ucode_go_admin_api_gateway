package function

import (
	"bytes"
	"encoding/json"
	"fmt"
	"io"
	"log"
	"net/http"
	"time"

	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api"
	"github.com/google/uuid"
	"github.com/spf13/cast"
)

const (
	apiKey = "%s"

	createURL    = "https://api.admin.u-code.io/v1/object/"
	createMethod = "POST"

	updateURL    = "https://api.admin.u-code.io/v1/object/"
	updateMethod = "PUT"

	getListURL    = "https://api.admin.u-code.io/v1/object/get-list/"
	getListMethod = "POST"

	getSingleURL    = "https://api.admin.u-code.io/v1/object/"
	getSingleMethod = "GET"

	multipleUpdateUrl    = "https://api.admin.u-code.io/v1/object/multiple-update/"
	multipleUpdateMethod = "PUT"
)

%s

func DoRequest(url string, method string, body interface{}) ([]byte, error) {
	data, err := json.Marshal(&body)
	if err != nil {
		return nil, err
	}
	client := &http.Client{
		Timeout: time.Duration(10 * time.Second),
	}

	request, err := http.NewRequest(method, url, bytes.NewBuffer(data))
	if err != nil {
		return nil, err
	}

	request.Header.Add("authorization", "API-KEY")
	request.Header.Add("X-API-KEY", apiKey)

	resp, err := client.Do(request)
	if err != nil {
		return nil, err
	}
	defer resp.Body.Close()

	respByte, err := io.ReadAll(resp.Body)
	if err != nil {
		return nil, err
	}

	return respByte, nil
}

func Handler(status, message string) string {
	var (
		response Response
		Message  = make(map[string]interface{})
	)

	// sendMessage("", status, message)
	response.Status = status
	data := Request{
		Data: map[string]interface{}{
			"data": message,
		},
	}
	response.Data = data.Data
	Message["message"] = message
	respByte, _ := json.Marshal(response)
	return string(respByte)
}

func sendMessage(functionName, errorStatus string, message interface{}) {
	bot, err := tgbotapi.NewBotAPI("")
	if err != nil {
		log.Panic(err)
	}

	chatID := int64(0)
	msg := tgbotapi.NewMessage(chatID, fmt.Sprintf("message from %s function: %s\n%s", functionName, errorStatus, message))
	_, err = bot.Send(msg)
	if err != nil {
		log.Panic(err)
	}
}

type Response struct {
	Status string                 `json:"status"`
	Data   map[string]interface{} `json:"data"`
}

type RequestBody struct {
	ObjectIDs []string    `json:"object_ids"`
	Data      RequestData `json:"data"`
}

type RequestData struct {
	ObjectData             map[string]interface{} `json:"object_data"`
	ObjectDataBeforeUpdate map[string]interface{} `json:"object_data_before_update"`
}

type ClientApiResponse struct {
	Data ClientApiData `json:"data"`
}

type ClientApiData struct {
	Data ClientApiResp `json:"data"`
}

type ClientApiResp struct {
	Response map[string]interface{} `json:"response"`
}

type Request struct {
	Data map[string]interface{} `json:"data"`
}

type MultipleUpdateRequest struct {
	Data Data `json:"data"`
}

type Data struct {
	Objects []map[string]interface{} `json:"objects"`
}

type GetListClientApiResponse struct {
	Data GetListClientApiData `json:"data"`
}

type GetListClientApiData struct {
	Data GetListClientApiResp `json:"data"`
}

type GetListClientApiResp struct {
	Response []map[string]interface{} `json:"response"`
}

type ResponseModel struct {
	Status string                 `json:"status"`
	Data   map[string]interface{} `json:"data"`
}

type CreateResponseBody struct {
	Data CreateResponseModel `json:"data"`
}

type CreateResponseModel struct {
	Data CreateResponse `json:"data"`
}

type CreateResponse struct {
	Data map[string]interface{} `json:"data"`
}
